import{s as n}from"./index-UkIvKgPy.js";const c="https://ccogznilfcqzpqtvbcne.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjb2d6bmlsZmNxenBxdHZiY25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NDI3ODAsImV4cCI6MjA4MjMxODc4MH0.gsR9RFWsS_-AAvDMuyXuGahnbkm-xTBgsxwHkSOMqXM";async function h(e,r="monthly"){try{const{data:{session:t}}=await n.auth.getSession();if(!t)throw new Error("You must be logged in to purchase a subscription");const s=await fetch(`${c}/functions/v1/razorpay-create-order`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`,apikey:u},body:JSON.stringify({plan_key:e,billing_interval:r})}),a=await s.json();if(!s.ok)throw new Error(a.error||a.message||"Failed to create order");if(a.error)throw new Error(a.error);return{success:!0,orderId:a.order_id,amount:a.amount,currency:a.currency,keyId:a.key_id,customerId:a.customer_id}}catch(t){return console.error("Error creating Razorpay order:",t),{success:!1,error:t.message||"Failed to create order. Please try again."}}}async function _(e){try{const{data:{session:r}}=await n.auth.getSession();if(!r)throw new Error("You must be logged in");const t=await fetch(`${c}/functions/v1/razorpay-verify-payment`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`,apikey:u},body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw new Error(s.error||s.message||"Failed to verify payment");if(s.error)throw new Error(s.error);return{success:!0,subscription:s.subscription}}catch(r){return console.error("Error verifying payment:",r),{success:!1,error:r.message||"Failed to verify payment. Please try again."}}}async function b(){try{const{data:e,error:r}=await n.from("subscriptions").select("*").eq("status","active").or("status.eq.trialing,status.eq.past_due").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Error fetching subscription:",e),{data:null,error:e}}}async function w(e){try{const{data:{session:r}}=await n.auth.getSession();if(!r)throw new Error("You must be logged in");const t=await fetch(`${c}/functions/v1/razorpay-cancel-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`,apikey:u},body:JSON.stringify({subscription_id:e})}),s=await t.json();if(!t.ok)throw new Error(s.error||s.message||"Failed to cancel subscription");if(s.error)throw new Error(s.error);return{success:!0}}catch(r){return console.error("Error canceling subscription:",r),{success:!1,error:r.message||"Failed to cancel subscription. Please try again."}}}async function S(e){try{const{data:{session:r}}=await n.auth.getSession();if(!r)throw new Error("You must be logged in");const t=await fetch(`${c}/functions/v1/razorpay-resume-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`,apikey:u},body:JSON.stringify({subscription_id:e})}),s=await t.json();if(!t.ok)throw new Error(s.error||s.message||"Failed to resume subscription");if(s.error)throw new Error(s.error);return{success:!0}}catch(r){return console.error("Error resuming subscription:",r),{success:!1,error:r.message||"Failed to resume subscription. Please try again."}}}async function I(e=50){try{const{data:r,error:t}=await n.from("billing_history").select("*").order("created_at",{ascending:!1}).limit(e);if(t)throw t;return{data:r,error:null}}catch(r){return console.error("Error fetching billing history:",r),{data:null,error:r}}}async function v(){try{const{data:e,error:r}=await n.from("payment_methods").select("*").order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Error fetching payment methods:",e),{data:null,error:e}}}async function E(){try{const{data:e,error:r}=await n.from("pricing_plans").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Error fetching pricing plans:",e),{data:null,error:e}}}async function k(){try{const{data:e,error:r}=await n.rpc("get_user_subscription_summary");if(r){const{data:{user:t}}=await n.auth.getUser();if(!t)return{data:null,error:null};const[s,a,d]=await Promise.all([n.from("subscriptions").select("*").eq("user_id",t.id).in("status",["active","trialing","past_due"]).order("created_at",{ascending:!1}).limit(1).maybeSingle(),n.from("licenses").select("*").eq("user_id",t.id).order("issued_at",{ascending:!1}).limit(1).maybeSingle(),n.from("billing_history").select("amount").eq("user_id",t.id).eq("status","paid")]),o=s.data,i=a.data,l=d.data||[];return{data:{user_id:t.id,email:t.email,subscription_id:o?.subscription_id||null,plan_type:o?.plan_type||i?.license_type||"free",subscription_status:o?.status||null,current_period_start:o?.current_period_start||null,current_period_end:o?.current_period_end||null,cancel_at_period_end:o?.cancel_at_period_end||!1,license_type:i?.license_type||"free",license_active:i?.is_active||!1,license_expires_at:i?.expires_at||null,total_payments:l.length,total_paid_amount:l.reduce((p,y)=>p+(y.amount||0),0)},error:null}}return{data:e?.[0]||null,error:null}}catch(e){return console.error("Error fetching subscription summary:",e),{data:null,error:e}}}function m(e,r="INR"){if(e==null)return"Contact Sales";const t=(e/100).toFixed(2);return new Intl.NumberFormat("en-IN",{style:"currency",currency:r.toUpperCase()}).format(t)}function z(e,r,t="INR"){if(e==null)return"Contact Sales";const s=m(e,t);return r==="yearly"?`${s}/year`:`${s}/month`}export{b as a,I as b,v as c,w as d,E as e,m as f,k as g,z as h,h as i,S as r,_ as v};
