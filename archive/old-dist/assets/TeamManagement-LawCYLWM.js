import{s as d,u as R,r as m,j as e,L as k}from"./index-UkIvKgPy.js";const F="https://ccogznilfcqzpqtvbcne.supabase.co",A="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjb2d6bmlsZmNxenBxdHZiY25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NDI3ODAsImV4cCI6MjA4MjMxODc4MH0.gsR9RFWsS_-AAvDMuyXuGahnbkm-xTBgsxwHkSOMqXM";async function B(){try{const{data:{user:t}}=await d.auth.getUser();if(!t)return{data:null,error:new Error("Not authenticated")};const{data:n,error:a}=await d.from("team_members").select(`
                *,
                teams (*)
            `).eq("user_id",t.id).eq("status","active");if(a)throw a;return{data:n?.map(l=>l.teams).filter(Boolean)||[],error:null}}catch(t){return console.error("Error fetching teams:",t),{data:null,error:t}}}async function U(t,n="data_pro"){try{const{data:{user:a}}=await d.auth.getUser();if(!a)return{data:null,error:new Error("Not authenticated")};const o=t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),{data:l,error:i}=await d.from("teams").insert({name:t,slug:o,owner_id:a.id,plan_type:n}).select().single();if(i)throw i;const{error:u}=await d.from("team_members").insert({team_id:l.team_id,user_id:a.id,role:"owner",status:"active",joined_at:new Date().toISOString()});if(u)throw u;return{data:l,error:null}}catch(a){return console.error("Error creating team:",a),{data:null,error:a}}}async function z(t){try{const{data:n,error:a}=await d.from("team_members").select(`
                *,
                user:auth.users!team_members_user_id_fkey (
                    id,
                    email
                )
            `).eq("team_id",t).order("role",{ascending:!1}).order("joined_at",{ascending:!1});if(a)throw a;return{data:n||[],error:null}}catch(n){return console.error("Error fetching team members:",n),{data:null,error:n}}}async function O(t,n,a="member"){try{const{data:{session:o}}=await d.auth.getSession();if(!o)throw new Error("You must be logged in");const l=await fetch(`${F}/functions/v1/team-invite-member`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`,apikey:A},body:JSON.stringify({team_id:t,email:n,role:a})}),i=await l.json();if(!l.ok)throw new Error(i.error||"Failed to invite member");return{success:!0}}catch(o){return console.error("Error inviting team member:",o),{success:!1,error:o.message||"Failed to invite member"}}}async function D(t,n){try{const{error:a}=await d.from("team_members").update({role:n}).eq("member_id",t);if(a)throw a;return{success:!0}}catch(a){return console.error("Error updating member role:",a),{success:!1,error:a.message||"Failed to update role"}}}async function J(t){try{const{error:n}=await d.from("team_members").update({status:"inactive"}).eq("member_id",t);if(n)throw n;return{success:!0}}catch(n){return console.error("Error removing member:",n),{success:!1,error:n.message||"Failed to remove member"}}}function H({session:t,navigate:n}){const a=R(),[o,l]=m.useState([]),[i,u]=m.useState(null),[v,y]=m.useState([]),[N,b]=m.useState(!0),[T,x]=m.useState(!1),[p,j]=m.useState(""),[g,C]=m.useState("member");m.useEffect(()=>{f()},[t]);const f=async()=>{if(t?.user){b(!0);try{const r=await B();if(r.error)throw r.error;l(r.data||[]),r.data&&r.data.length>0&&!i&&(u(r.data[0]),h(r.data[0].team_id))}catch(r){console.error("Error loading teams:",r),a.error("Failed to load teams")}finally{b(!1)}}},h=async r=>{try{const s=await z(r);if(s.error)throw s.error;y(s.data||[])}catch(s){console.error("Error loading team members:",s),a.error("Failed to load team members")}},_=async r=>{if(r)try{const s=await U(r);if(s.error)throw s.error;a.success("Team created successfully"),f(),s.data&&(u(s.data),h(s.data.team_id))}catch(s){console.error("Error creating team:",s),a.error("Failed to create team")}},E=async()=>{if(!(!i||!p))try{const r=await O(i.team_id,p,g);if(!r.success)throw new Error(r.error||"Failed to invite member");a.success(`Invitation sent to ${p}`),x(!1),j(""),h(i.team_id)}catch(r){console.error("Error inviting member:",r),a.error(r.message||"Failed to send invitation")}},M=async(r,s)=>{try{const c=await D(r,s);if(!c.success)throw new Error(c.error||"Failed to update role");a.success("Role updated"),h(i.team_id)}catch(c){console.error("Error updating role:",c),a.error(c.message||"Failed to update role")}},S=async r=>{if(confirm("Are you sure you want to remove this member?"))try{const s=await J(r);if(!s.success)throw new Error(s.error||"Failed to remove member");a.success("Member removed"),h(i.team_id)}catch(s){console.error("Error removing member:",s),a.error(s.message||"Failed to remove member")}};return N?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"48px"},children:e.jsx(k,{})}):e.jsxs("div",{className:"team-management",children:[e.jsx("div",{className:"dashHero",children:e.jsxs("div",{className:"container dashHero__inner",children:[e.jsx("p",{className:"dashHero__kicker",children:"Teams"}),e.jsx("h1",{className:"dashHero__title",children:"Team Management"}),e.jsx("p",{className:"dashHero__subtitle",children:"Manage your teams, invite members, and control access."})]})}),e.jsx("section",{className:"dashSection",children:e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"dashCard",style:{marginBottom:"24px"},children:[e.jsx("h2",{className:"dashCard__title",children:"Your Teams"}),o.length===0?e.jsxs("div",{children:[e.jsx("p",{style:{marginBottom:"16px",color:"var(--dr-muted)"},children:"You don't have any teams yet. Create one to start sharing access and usage limits across a small group."}),e.jsx("p",{style:{marginBottom:"16px",color:"var(--dr-muted)"},children:"Tip: teams only affect account access and billing/limits. Your datasets and models still stay local."}),e.jsx("button",{className:"button button--primary",onClick:()=>{const r=prompt("Enter team name:");r&&_(r)},children:"Create Team"})]}):e.jsxs("div",{className:"adminTabs",children:[o.map(r=>e.jsx("button",{className:`adminTab ${i?.team_id===r.team_id?"adminTab--active":""}`,onClick:()=>{u(r),h(r.team_id)},children:r.name},r.team_id)),e.jsx("button",{className:"button button--outline",onClick:()=>{const r=prompt("Enter team name:");r&&_(r)},style:{marginLeft:"auto"},children:"+ New Team"})]})]}),i&&e.jsxs("div",{className:"dashCard",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[e.jsx("h2",{className:"dashCard__title",children:"Team Members"}),e.jsx("button",{className:"button button--primary",onClick:()=>x(!0),children:"Invite Member"})]}),v.length===0?e.jsx("div",{className:"dashMuted",style:{padding:"24px",textAlign:"center"},children:"No members yet. Invite a teammate (or add a second email you own) to validate access and role permissions."}):e.jsxs("div",{className:"dashTable",children:[e.jsxs("div",{className:"dashTable__head",children:[e.jsx("div",{children:"Member"}),e.jsx("div",{children:"Role"}),e.jsx("div",{children:"Status"}),e.jsx("div",{children:"Joined"}),e.jsx("div",{children:"Actions"})]}),v.map(r=>{const s=r.role==="owner",c=r.user_id===t?.user?.id,w=i.owner_id===t?.user?.id||r.role==="admin";return e.jsxs("div",{className:"dashTable__row",children:[e.jsx("div",{children:r.user?.email||r.user_id?.substring(0,8)+"..."||"Unknown User"}),e.jsx("div",{children:e.jsxs("select",{value:r.role,onChange:I=>M(r.member_id,I.target.value),disabled:s||!w||c,style:{padding:"4px 8px",border:"1px solid var(--dr-border)",borderRadius:"4px",fontSize:"14px"},children:[e.jsx("option",{value:"owner",children:"Owner"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"member",children:"Member"}),e.jsx("option",{value:"viewer",children:"Viewer"})]})}),e.jsx("div",{children:e.jsx("span",{className:`dashStatus dashStatus--${r.status==="active"?"active":"archived"}`,children:r.status})}),e.jsx("div",{children:r.joined_at?new Date(r.joined_at).toLocaleDateString():r.invited_at?`Invited ${new Date(r.invited_at).toLocaleDateString()}`:"—"}),e.jsx("div",{children:!s&&w&&!c&&e.jsx("button",{className:"button button--outline",onClick:()=>S(r.member_id),style:{fontSize:"12px",padding:"4px 8px",height:"auto"},children:"Remove"})})]},r.member_id)})]})]}),i&&e.jsxs("div",{className:"dashCard",style:{marginTop:"24px"},children:[e.jsx("h2",{className:"dashCard__title",children:"Team Settings"}),e.jsxs("div",{className:"dashRows",children:[e.jsxs("div",{className:"dashRow",children:[e.jsx("div",{className:"dashRow__label",children:"Team Name"}),e.jsx("div",{className:"dashRow__value",children:i.name})]}),e.jsxs("div",{className:"dashRow",children:[e.jsx("div",{className:"dashRow__label",children:"Plan"}),e.jsx("div",{className:"dashRow__value",children:i.plan_type?.replace("_"," ").replace(/\b\w/g,r=>r.toUpperCase())||"Free"})]}),e.jsxs("div",{className:"dashRow",children:[e.jsx("div",{className:"dashRow__label",children:"Max Members"}),e.jsx("div",{className:"dashRow__value",children:i.max_members||"Unlimited"})]})]}),i.owner_id===t?.user?.id&&e.jsx("div",{className:"dashActions",style:{marginTop:"24px"},children:e.jsx("a",{className:"button button--primary",href:"/pricing",onClick:r=>{r.preventDefault(),n("/pricing")},children:"Upgrade Team Plan"})})]})]})}),T&&e.jsx("div",{className:"modal-overlay",onClick:()=>x(!1),children:e.jsxs("div",{className:"modal-content",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Invite Team Member"}),e.jsx("button",{className:"modal-close",onClick:()=>x(!1),children:"×"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500"},children:"Email Address"}),e.jsx("input",{type:"email",value:p,onChange:r=>j(r.target.value),placeholder:"user@example.com",style:{width:"100%",padding:"12px",border:"1px solid var(--dr-border)",borderRadius:"8px",fontSize:"16px"}})]}),e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500"},children:"Role"}),e.jsxs("select",{value:g,onChange:r=>C(r.target.value),style:{width:"100%",padding:"12px",border:"1px solid var(--dr-border)",borderRadius:"8px",fontSize:"16px"},children:[e.jsx("option",{value:"viewer",children:"Viewer"}),e.jsx("option",{value:"member",children:"Member"}),e.jsx("option",{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"button button--outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx("button",{className:"button button--primary",onClick:E,disabled:!p,children:"Send Invitation"})]})]})})]})}export{H as TeamManagement};
