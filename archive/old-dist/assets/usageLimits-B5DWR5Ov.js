import{s as n}from"./index-UkIvKgPy.js";const u="https://ccogznilfcqzpqtvbcne.supabase.co",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjb2d6bmlsZmNxenBxdHZiY25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NDI3ODAsImV4cCI6MjA4MjMxODc4MH0.gsR9RFWsS_-AAvDMuyXuGahnbkm-xTBgsxwHkSOMqXM";async function h(e,r){try{const{data:{session:t}}=await n.auth.getSession();if(!t)throw new Error("You must be logged in");const a=await fetch(`${u}/functions/v1/razorpay-upgrade-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`,apikey:l},body:JSON.stringify({subscription_id:e,new_plan_key:r})}),s=await a.json();if(!a.ok)throw new Error(s.error||s.message||"Failed to upgrade subscription");if(s.error)throw new Error(s.error);return{success:!0,subscription:s.subscription,proratedAmount:s.prorated_amount}}catch(t){return console.error("Error upgrading subscription:",t),{success:!1,error:t.message||"Failed to upgrade subscription. Please try again."}}}async function w(e,r,t=!1){try{const{data:{session:a}}=await n.auth.getSession();if(!a)throw new Error("You must be logged in");const s=await fetch(`${u}/functions/v1/razorpay-downgrade-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`,apikey:l},body:JSON.stringify({subscription_id:e,new_plan_key:r,immediate:t})}),o=await s.json();if(!s.ok)throw new Error(o.error||o.message||"Failed to downgrade subscription");if(o.error)throw new Error(o.error);return{success:!0,subscription:o.subscription}}catch(a){return console.error("Error downgrading subscription:",a),{success:!1,error:a.message||"Failed to downgrade subscription. Please try again."}}}async function _(e){try{const{data:r,error:t}=await n.from("subscription_changes").select("*").eq("subscription_id",e).order("created_at",{ascending:!1});if(t)throw t;return{data:r,error:null}}catch(r){return console.error("Error fetching subscription change history:",r),{data:null,error:r}}}async function y(){try{const{data:{user:e}}=await n.auth.getUser();if(!e)return{data:null,error:null};const{data:r,error:t}=await n.from("trials").select("*").eq("user_id",e.id).eq("converted",!1).eq("canceled",!1).gt("trial_end",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;return{data:r,error:null}}catch(e){return console.error("Error fetching active trial:",e),{data:null,error:e}}}async function b(e,r){try{const{data:{session:t}}=await n.auth.getSession();if(!t)throw new Error("You must be logged in");const a=await fetch(`${u}/functions/v1/razorpay-calculate-proration`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`,apikey:l},body:JSON.stringify({subscription_id:e,new_plan_key:r})}),s=await a.json();if(!a.ok)throw new Error(s.error||s.message||"Failed to calculate proration");if(s.error)throw new Error(s.error);return{success:!0,proratedAmount:s.prorated_amount,breakdown:s.breakdown}}catch(t){return console.error("Error calculating prorated amount:",t),{success:!1,error:t.message||"Failed to calculate proration"}}}async function m(e){try{const{data:{user:r}}=await n.auth.getUser();if(!r)return{data:null,error:"Not authenticated"};const{data:t}=await n.from("subscriptions").select("current_period_start, current_period_end").eq("subscription_id",e).single();if(!t)return{data:null,error:"Subscription not found"};const{data:a,error:s}=await n.from("gpu_usage").select("*").eq("user_id",r.id).gte("usage_start",t.current_period_start).lte("usage_end",t.current_period_end);if(s)throw s;const o=a?.reduce((i,c)=>i+parseFloat(c.hours_used||0),0)||0,d=a?.reduce((i,c)=>i+parseFloat(c.total_cost||0),0)||0;return{data:{gpuUsage:a||[],totalHours:o,totalCost:d,usageCount:a?.length||0},error:null}}catch(r){return console.error("Error fetching subscription usage:",r),{data:null,error:r}}}async function p(){try{const{data:{user:e}}=await n.auth.getUser();if(!e)return{data:null,error:new Error("Not authenticated")};const r=new Date;r.setDate(1),r.setHours(0,0,0,0);const{data:t,error:a}=await n.from("usage_tracking").select("*").eq("user_id",e.id).eq("period_start",r.toISOString()).order("period_start",{ascending:!1}).limit(1).maybeSingle();if(a&&a.code!=="PGRST116")throw a;return{data:t,error:null}}catch(e){return e?.code==="42501"?{data:null,error:null}:(console.error("Error getting current usage:",e),{data:null,error:e})}}async function g(){try{const{data:{user:e}}=await n.auth.getUser();if(!e)return{data:null,error:new Error("Not authenticated")};const{data:r}=await n.from("subscriptions").select("plan_type").eq("user_id",e.id).in("status",["active","trialing"]).order("created_at",{ascending:!1}).limit(1).maybeSingle();let t=r?.plan_type||"free";if(t==="free"){const{data:o}=await n.from("licenses").select("license_type").eq("user_id",e.id).eq("is_active",!0).order("issued_at",{ascending:!1}).limit(1).maybeSingle();o&&(o.license_type==="pro"?t="train_pro":o.license_type==="enterprise"?t="enterprise":t=o.license_type)}const{data:a,error:s}=await n.from("usage_limits").select("*").eq("plan_type",t).single();if(s)throw s;return{data:a,error:null}}catch(e){return e?.code==="42501"?{data:null,error:null}:(console.error("Error getting usage limits:",e),{data:null,error:e})}}async function S(){const[e,r]=await Promise.all([p(),g()]),t=e.data||{projects_count:0,exports_count:0,gpu_hours_used:0,training_runs_count:0},a=r.data||{},s=a.plan_type||"free";return{usage:t,limits:a,tier:s}}function E(e,r){return r===-1||r===null?-1:r===0?100:Math.min(100,Math.round(e/r*100))}function k(e,r){return r===-1||r===null?!1:e>=r*.8}function I(e,r){return r===-1||r===null?!1:e>=r}export{I as a,m as b,y as c,S as d,b as e,w as f,E as g,_ as h,k as i,h as u};
